suite: test namespace override
templates:
  # Workloads
  - miggo-collector/deployment.yaml
  - miggo-scanner/deployment.yaml
  - miggo-watch/deployment.yaml
  # RBAC
  - miggo-collector/rolebinding.yaml
  - miggo-scanner/rolebinding.yaml
  - miggo-collector/role.yaml
  - miggo-collector/serviceaccount.yaml
  # Network
  - miggo-collector/service.yaml
  # Config & Secrets
  - miggo-collector/collector-config-cm.yaml
  - access-key-secret.yaml
  - image-pull-secret.yaml
tests:
  - it: should use custom namespace in collector deployment metadata
    template: miggo-collector/deployment.yaml
    asserts:
      - equal:
          path: metadata.namespace
          value: miggo-custom

  - it: should use custom namespace in scanner deployment metadata
    template: miggo-scanner/deployment.yaml
    asserts:
      - equal:
          path: metadata.namespace
          value: miggo-custom

  - it: should use custom namespace in rolebinding metadata
    template: miggo-collector/rolebinding.yaml
    asserts:
      - equal:
          path: metadata.namespace
          value: miggo-custom
      - equal:
          path: subjects[0].namespace
          value: miggo-custom

  - it: should use custom namespace in scanner rolebinding
    template: miggo-scanner/rolebinding.yaml
    documentIndex: 1
    asserts:
      - equal:
          path: metadata.namespace
          value: miggo-custom
      - equal:
          path: subjects[0].namespace
          value: miggo-custom

  - it: should use custom namespace in serviceaccount
    template: miggo-collector/serviceaccount.yaml
    asserts:
      - equal:
          path: metadata.namespace
          value: miggo-custom

  - it: should use custom namespace in service
    template: miggo-collector/service.yaml
    asserts:
      - equal:
          path: metadata.namespace
          value: miggo-custom

  - it: should use custom namespace in role
    template: miggo-collector/role.yaml
    asserts:
      - equal:
          path: metadata.namespace
          value: miggo-custom

  - it: should use custom namespace in watch deployment metadata
    template: miggo-watch/deployment.yaml
    asserts:
      - equal:
          path: metadata.namespace
          value: miggo-custom

  - it: should use custom namespace in configmap
    template: miggo-collector/collector-config-cm.yaml
    asserts:
      - equal:
          path: metadata.namespace
          value: miggo-custom

  - it: should use custom namespace in access-key secret
    template: access-key-secret.yaml
    asserts:
      - equal:
          path: metadata.namespace
          value: miggo-custom

  - it: should use custom namespace in image-pull secret
    template: image-pull-secret.yaml
    asserts:
      - equal:
          path: metadata.namespace
          value: miggo-custom

  - it: should use custom namespace in service URLs
    template: miggo-scanner/deployment.yaml
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[0].args
          pattern: ".*http://miggo-collector.miggo-custom.svc.cluster.local:4318.*"
      - matchRegex:
          path: spec.template.spec.containers[0].args
          pattern: ".*--cache-cm-namespace=miggo-custom.*"

