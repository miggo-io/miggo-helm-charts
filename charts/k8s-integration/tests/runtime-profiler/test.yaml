suite: runtime profiler

release:
  name: miggo
  namespace: miggo-space

templates:
  - templates/collector/deployment.yaml
  - templates/collector/collector-config-cm.yaml
  - templates/sensor/daemonset.yaml

values:
  - values.yaml

tests:
  - it: should configure collector to enable profiles signal
    template: templates/collector/deployment.yaml
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: spec.template.spec.containers[?(@.name == "miggo-collector")].args
          value:
            - --config
            - /etc/collector/config.yaml
            - --feature-gates
            - service.profilesSupport
  - it: should configure collector to receive and export profiles
    template: templates/collector/collector-config-cm.yaml
    asserts:
      - isKind:
          of: ConfigMap
      - equal:
          path: data["config.yaml"]
          value: |
            extensions:
              health_check:
                endpoint: 0.0.0.0:6666
              oauth2client:
                client_id: P2UjsJwOFdIeUAtW0pGTJ5SeJAlq
                client_secret_file: /etc/miggo-access-key
                token_url: https://api.descope.com/oauth2/v1/token
                timeout: 1m

            receivers:
              otlp:
                protocols:
                  grpc:
                    endpoint: "0.0.0.0:4317"
                  http:
                    endpoint: "0.0.0.0:4318"

            processors:
              batch:
                timeout: 10s

            exporters:

              debug:
                verbosity:

              prometheus:
                endpoint: 0.0.0.0:8889

              otlphttp:
                traces_endpoint: https://api.miggo.io/v1/traces
                metrics_endpoint: https://api.miggo.io/v1/metrics
                logs_endpoint: https://api.miggo.io/v1/logs
                auth:
                  authenticator: oauth2client
              otlphttp/profiles:
                endpoint: https://api.miggo.io
                auth:
                  authenticator: oauth2client

            service:
              extensions: [health_check, oauth2client]
              pipelines:
                profiles:
                  receivers: [otlp]
                  exporters: [otlphttp/profiles]
                metrics:
                  receivers: [otlp]
                  processors: [batch]
                  exporters: [debug, prometheus, otlphttp]
                traces:
                  receivers: [otlp]
                  processors: [batch]
                  exporters: [debug, otlphttp]
                logs:
                  receivers: [otlp]
                  processors: [batch]
                  exporters: [debug, otlphttp]
  - it: should add both miggo-sensor and profiler containers to the DaemonSet spec
    template: templates/sensor/daemonset.yaml
    asserts:
      - isKind:
          of: DaemonSet
      - equal:
          path: spec.template.spec.containers[?(@.name == "miggo-sensor")].args
          value:
            - --cluster-name=simple-test
            - --tenant-name=1b4a61e8-cdc8-4174-87bf-8201406ee65e
            - --project-name=8f74294c-c769-4746-b1f3-cc20eecf0149
            - --otlp-endpoint=http://miggo-collector.miggo-space.svc.cluster.local:4318
            - --collector-healthcheck-port=6666
            - --tls-skip-verify=false
            - --stdout=false
            - --port=6666
            - --metric-otlp-endpoint=http://miggo-collector.miggo-space.svc.cluster.local:4318
            - --metric-tls-skip-verify=false
            - --metric-interval=60s
            - --disable-profiler=false
      - equal:
          path: spec.template.spec.containers[?(@.name == "miggo-sensor")].securityContext
          value:
            privileged: true
      - equal:
          path: spec.template.spec.containers[?(@.name == "miggo-sensor")].volumeMounts
          value:
            - name: debugfs
              mountPath: /sys/kernel/debug
              readOnly: true
            - name: unix-socket
              mountPath: /tmp/grpc
      - equal:
          path: spec.template.spec.containers[?(@.name == "profiler")].image
          value: "registry.miggo.io/miggoprod/miggo-profiler:latest"
      - equal:
          path: spec.template.spec.containers[?(@.name == "profiler")].command
          value:
            - /root/ebpf-profiler
      - equal:
          path: spec.template.spec.containers[?(@.name == "profiler")].args
          value:
            - -collection-agent=miggo-collector.miggo-space.svc.cluster.local:4317
            - -disable-tls=true
            - -reporter-interval=5s
            - -samples-per-second=20
            - -monitor-interval=5s
            - -off-cpu-threshold=1000
            - -probabilistic-threshold=100
            - -probabilistic-interval=1m0s
      - equal:
          path: spec.template.spec.containers[?(@.name == "profiler")].securityContext
          value:
            allowPrivilegeEscalation: true
            privileged: true
            capabilities:
              add:
                - SYS_ADMIN
      - equal:
          path: spec.template.spec.containers[?(@.name == "profiler")].volumeMounts
          value:
            - name: debugfs
              mountPath: /sys/kernel/debug
              readOnly: true
            - name: cgroupfs
              mountPath: /cgroup
              readOnly: true
            - name: unix-socket
              mountPath: /tmp/grpc
      - equal:
          path: spec.template.spec.volumes
          value:
            - name: debugfs
              hostPath:
                path: /sys/kernel/debug
            - name: unix-socket
              emptyDir: { }
            - name: cgroupfs
              hostPath:
                path: /sys/fs/cgroup
      - equal:
          path: spec.template.spec.hostPID
          value: true
      - equal:
          path: spec.template.spec.hostIPC
          value: true
  - it: should enable Off-CPU profiler
    template: templates/sensor/daemonset.yaml
    set:
      sensor:
        profiler:
          offCpuThreshold: 1
          probabilisticThreshold: 1
    asserts:
      - isKind:
          of: DaemonSet
      - equal:
          path: spec.template.spec.containers[?(@.name == "profiler")].args
          value:
            - -collection-agent=miggo-collector.miggo-space.svc.cluster.local:4317
            - -disable-tls=true
            - -reporter-interval=5s
            - -samples-per-second=20
            - -monitor-interval=5s
            - -off-cpu-threshold=1
            - -probabilistic-threshold=1
            - -probabilistic-interval=1m0s
